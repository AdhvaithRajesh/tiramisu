







<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Large git objects and the power of git rebase.</title>
  <link rel="preload stylesheet" href="/static/style.css" as="style" />

  
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js"></script>
  
  
  <script src="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/highlightjs-copy/dist/highlightjs-copy.min.css" />


  <link rel="alternate" type="application/atom+xml" title="feed" href="/feed.xml" />


  
  
  <script>
    const eventSource = new EventSource('http://localhost:8000/events');
    eventSource.onmessage = function (event) {
      location.reload()
    };
  </script>
  

   


  <meta property="og:type" content="website" />
  <meta property="og:title" content="Large git objects and the power of git rebase." />
  <meta property="og:description" content="The mystry of large git object and a working knoweldge of git rebase." />
  <meta property="og:image" content="" />

  <meta name="description" content="The mystry of large git object and a working knoweldge of git rebase.">

  <script defer>
    hljs.highlightAll();
    hljs.addPlugin(new CopyButtonPlugin());
  </script>
</head>


<body>

    

 

<header>
    <nav>
         
        <a class="navitem" href="/index.html">[home]</a>
          
        <a class="navitem" href="/about.html">[about]</a>
          
        <a class="navitem" href="/collections/blog.html">[blog]</a>
          
        <a class="navitem" href="/members.html">[members]</a>
          
        <a class="navitem" href="/history.html">[history]</a>
          
        <a class="navitem" href="/tags.html">[tags]</a>
          
        <a class="navitem" href="/homebrew/index.html">[homebrew]</a>
         
    </nav>
</header>

<form class="siteSearch" id="searchSite">
  <input type="text" placeholder="Search Post or Page" id="searchSiteInput" name="searchSite" required autocomplete="off" />
</form>
<div id="site_search_result"></div>
<script>
  var resultDiv = document.getElementById("site_search_result");
  document
    .getElementById("searchSite")
    .addEventListener("keyup", function (e) {
      e.preventDefault();
      const searchValue =
        document.getElementById("searchSiteInput").value;

      const url = "/static/index.json";

      fetch(url)
        .then((response) => {
          if (!response.ok) {
            throw new Error("Network response was not ok");
          }
          return response.json();
        })
        .then((data) => {
          resultDiv.innerHTML = "";
          found = 0;
          if (searchValue != "") {
            for (key in data) {
              found += 1;
              title =
                data[key]["Frontmatter"]["Title"].toLowerCase();
              if (title.includes(searchValue.toLowerCase())) {
                var a = document.createElement("a");
                a.innerHTML = data[key]["Frontmatter"]["Title"];
                a.href = `/${data[key]["CompleteURL"]}`;
                resultDiv.appendChild(a);
                resultDiv.appendChild(
                  document.createElement("br"),
                );
              }
            }
          } else {
            document.getElementById("site_search_result").innerHTML = "";
          }
        })
        .catch((error) => {
          
          console.error(
            "There was a problem with the fetch operation:",
            error,
          );
        });
    });
</script>
 
    <article>
        <section class="body">
            
            <div class="post-description">
                <h1>Large git objects and the power of git rebase.</h1>
                <div class="authors-paceholder">
                    <p>
                        Published on 2022-12-31
                        
                        
                        HSP
                        
                    </p>
                </div>
                <div class="tags-paceholder">
                    
                    <div class="tag">
                        <a href="/tags/git.html">git</a>
                    </div>
                    
                    <div class="tag">
                        <a href="/tags/rebase.html">rebase</a>
                    </div>
                    
                    <div class="tag">
                        <a href="/tags/gitobjects.html">gitobjects</a>
                    </div>
                    
                </div>
            </div>
            
            <h1 id="table-of-contents">Table of Contents <a class="anchor" href="#table-of-contents">#</a></h1>
<ul>
<li>
<a href="#preface">Preface</a><ul>
<li>
<a href="#large-objects-why-did-i-just-clone-150-mb">Large Objects: Why did I just clone ~150 MB?</a></li>
<li>
<a href="#solution-rebase-or-git-filter-branch">Solution: Rebase or git filter-branch</a><ul>
<li>
<a href="#git-rebase">git rebase</a></li>
<li>
<a href="#applying-rebase">Applying rebase</a></li>
</ul>
</li>
<li>
<a href="#conclusion">Conclusion</a></li>
</ul>
</li>
</ul>
<h1 id="preface">Preface <a class="anchor" href="#preface">#</a></h1>
<p><code>git rebase</code>, is a command I've heard only the true git master ninjas use. A command that baffled me for years was finally demystified! Let's first set the scene. I wanted to read some code (source code) from the site you are currently browsing, so like all programmers I went ahead and cloned the repo. It was SLOW, why? well, git was trying to clone ~150 MB of data. WHAT, why?</p>
<blockquote>
<p>Note: I had already fixed the issues, force pushed and cleared my reflog. Hence I had to rebuild the said issues, so it may seem a bit off.</p>
</blockquote>
<h2 id="large-objects-why-did-i-just-clone-150-mb">Large Objects: Why did I just clone ~150 MB? <a class="anchor" href="#large-objects-why-did-i-just-clone-150-mb">#</a></h2>
<p>So, typically I first did this :</p>
<pre><code class="language-bash">git clone git@github.com:NavinShrinivas/homebrew-internethome.git
</code></pre>
<blockquote>
<p>Note: The above repo is a fork of this website with this issue replicated.</p>
</blockquote>
<p>And this is where we first notice something off :
<img src="https://imgur.com/7SrYL9o.png" alt="image of large object during clone"></p>
<p>One's first guess would be large file size, so let's go in search of it :</p>
<pre><code class="language-bash">du | sort -n
</code></pre>
<figure>
<img src="https://imgur.com/qfoR6Oy.png" alt="checking file size and sorting">
<figcaption><p>What we instead see here is that the .git folder (something that we don't manually track) is the largest! Well, now I gotta see why is the image in the .git being so large. After googling a bit and I found this nifty script that tells which item in the repository is consuming the maximum space in the images.</p></figcaption>
</figure>
<pre><code class="language-bash">git rev-list --objects --all |
git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' |
sed -n 's/^blob //p' |
sort --numeric-sort --key=2 |
cut -c 1-12,41- |
$(command -v gnumfmt || echo numfmt) --field=2 --to=iec-i --suffix=B --padding=7 --round=nearest
</code></pre>
<blockquote>
<p>Note: the above command acts as 1, it doesn't hold much importance in this blog.</p>
</blockquote>
<figure>
<img src="https://imgur.com/OwtXpsZ.png" alt="image showing induvidual item in object sizes">
</figure>
<p>Well well well, it's not a single file making this happen. It's a bunch of font files that are bloating the image. Phew, easy fix, let's just delete those files no? Well, if one does a <code>ls</code> on the repo, there is no folder 16/ or those files!!! That's when it occurs to me, those folders are no more part of the tracked files but git is having them tracked in previous commits (One for the addition of those files and another commit for deletion of them).</p>
<h2 id="solution-rebase-or-git-filter-branch">Solution: Rebase or git filter-branch <a class="anchor" href="#solution-rebase-or-git-filter-branch">#</a></h2>
<p>Before I could fix this, I need to find the commit that introduced and deleted these items. A quick GitHub search gives me what I'm looking for.
<a href="https://github.com/NavinShrinivas/homebrew-internethome/commit/70e96ff861b572d5a7430970bdb9fc72615d9712">addition commit</a>
<a href="https://github.com/NavinShrinivas/homebrew-internethome/commit/b37d866776e1186b2c2d46d5759d15ae7b5c6ba9">deletion commit</a></p>
<p>One of the other solutions that I came across was a git filter branch that allows you to execute a command on every commit (between 2 hashes). So one could have simply removed the existence of that folder from every commit between those two.</p>
<p>But I went the rebase way. Now would be a good time to gain intuition on rebase.</p>
<h3 id="git-rebase">git rebase <a class="anchor" href="#git-rebase">#</a></h3>
<p>Surprisingly, rebase has all it has to right in its name. It lets you change the base of a given branch. That is, it lets you modify the base (previous commit) keeping the head the same!</p>
<h3 id="applying-rebase">Applying rebase <a class="anchor" href="#applying-rebase">#</a></h3>
<p>I used an &quot;interactive&quot; mode for git rebase, this can be done by :</p>
<pre><code class="language-bash">git rebase -i hash_of_commit_you_want_to_rebase_from
</code></pre>
<p>In our case, I decided to rebase from <a href="https://github.com/NavinShrinivas/homebrew-internethome/commit/886448910588f6332c665abd8af44cbca4fd7e2d">here</a>(it's the commit right behind the addition commit)</p>
<pre><code class="language-bash">git rebase -i 886448910588f6332c665abd8af44cbca4fd7e2d
</code></pre>
<p>This opens up a nice document in your editor :
<img src="https://imgur.com/I7HMBbu.png" alt="interactive rebase">
Let's save and quit this document after changing those 2 commits to edit. Git being the very elaborate tool it is stops at all those commits we've asked to edit.
<img src="https://imgur.com/B2Fkz1d.png" alt="edit commit 1">
Now, we can do whatever change we want, and do <code>git add .</code>. Then let's simply follow what git tells us by doing amend and continue. In our case :</p>
<pre><code class="language-bash">$ rm -rf 16
$ git add .
$ git commit --amend #save and quit
$ git rebase --continue
</code></pre>
<figure>
<img src="https://imgur.com/6ffxxka.png" alt="image after first rebase fix">
<figcaption><p>For our second commit fix, it's like we never had the folder called 16. So we don't have to do anything. Just amend and continue!
<img src="https://imgur.com/xo8MITF.png" alt="image after rebase commit 2">
So in theory we have entered our commit history and removed the existence of those files EVER. All we gotta do is push these changes to the remote.
Oh, uhh. The histories are different, which implies we need to force push. This also means others have to force pull :(</p></figcaption>
</figure>
<p>It was at this point I figured that this solution does fix my problem but is not the perfect way. Little googling tells me that there are better ways to rebase.
Anyways, let's force push and clone again to see if our fix worked.</p>
<h2 id="conclusion">Conclusion <a class="anchor" href="#conclusion">#</a></h2>
<pre><code class="language-bash">git clone git@github.com:homebrew-ec-foss/homebrew-internethome.git
</code></pre>
<blockquote>
<p>Note: the repo I'm cloning here is the one that is fixed!</p>
</blockquote>
<figure>
<img src="https://imgur.com/90C9lRB.png" alt="clone after rebase">
<figcaption><p>WOOT! 5 MB was our clone size and it was much faster! This goes to show, git is a powerful tool, we simply don't know what it can do. I conclude this blog with a quote by one of my friends &quot;The best way to learn git is to need it.&quot;</p></figcaption>
</figure>

        </section>
    </article>
    
<footer>
    Rendered using <a href="https://github.com/anna-ssg/anna">anna</a> ❤️
</footer>

    <script>
        hljs.highlightAll();
        hljs.addPlugin(new CopyButtonPlugin());
    </script>
</body>

</html>

